#!/bin/bash

git submodule update --init

update () {
  rm -rf "$HOME/.$1"
  ln -s "$PWD/$1" "$HOME/.$1"
}

mk-dir-if-not-found () {
  [[ ! -d "$1" ]] &&
    mkdir -p "$1"
}

update zshrc
update inputrc
update gvimrc
update vimrc
update tmux.conf
update gitignore
update gitconfig
update R
update Rprofile
update dircolors

rm -rf $HOME/scripts
ln -s $PWD/scripts $HOME/scripts

mk-dir-if-not-found $HOME/.ssh
[[ -f $HOME/.ssh/config ]] && mv $HOME/.ssh/config{,.bkup}
ln -s $PWD/ssh-config $HOME/.ssh/config

mk-dir-if-not-found $HOME/.cache/zsh

mk-dir-if-not-found $HOME/.rstat/lib

mk-dir-if-not-found $HOME/.ipython/profile_default
ln -s $PWD/ipython_config.py $HOME/.ipython/profile_default/ipython_config.py

# Assuming the submodule is populated
fzf/uninstall
fzf/install
rm $HOME/.fzf.{ba,z}sh
git checkout .

if [[ "$1" == "--vundle" || "$2" == "--vundle" ]]; then
  rm -rf $HOME/.vim
  mkdir -p $HOME/.vim/bundle
  git clone 'https://github.com/VundleVim/Vundle.vim' \
      $HOME/.vim/bundle/Vundle.vim
  vim +PluginInstall +qall
fi

rm -rf $HOME/.tmux/plugins/tpm
git clone 'https://github.com/tmux-plugins/tpm' $HOME/.tmux/plugins/tpm

rm -rf $HOME/.zprompt/pure
git clone 'https://github.com/sindresorhus/pure.git' $HOME/.zprompt/pure

if [[ "$1" == "--wsl" || "$2" == "--wsl" ]]; then

  sudo cp wsl.conf /etc/wsl.conf
  sudo apt-get update && sudo apt-get upgrade
  sudo apt-get install zsh fortune-mod cowsay x11-apps \
    mlocate mupdf r-base vim-gtk3 unzip ripgrep mplayer \
    virtualenv python3-pip tree dos2unix python3-tk \
    fonts-firacode fonts-cascadia-code bat fd-find
  pip install scipy pandas ipython statsmodels
  chsh

  MNT=/mnt
  get_win_var () {
    wslpath -u $(cmd.exe /c echo $1 2> /dev/null) | tr -d ''
  }

  ln -s $MNT/c $HOME/c
  ln -s $MNT/d $HOME/d
  ln -s $MNT/c/Users/$(get_win_var %USERNAME%) $HOME/winhome
  ln -s $HOME/winhome/Documents $HOME/doc
  ln -s $HOME/winhome/Downloads $HOME/tmp
  ln -s $(get_win_var %TMP%) $HOME/temp

  mk-dir-if-not-found $HOME/.ssh
  sudo cp $HOME/winhome/.ssh/* $HOME/.ssh/
  sudo chown $USER:$USER $HOME/.ssh/*
  chmod 400 $HOME/.ssh/*
  chmod 600 $HOME/.ssh/known_hosts

  PS_DIR=$HOME/winhome/Documents/WindowsPowerShell/
  PS_PROF=Microsoft.PowerShell_profile.ps1
  mk-dir-if-not-found $PS_DIR
  if [[ -f $PS_DIR/$PS_PROF ]]; then
    cat $PS_PROF >> $PS_DIR/$PS_PROF
  else
    cp $PS_PROF $PS_DIR/
  fi

  cat zshrc.wsl >> $HOME/.zshrc.more

  source zshrc.wsl; cp $PWD/windows-terminal-settings.json $WIN_TERM_SETTINGS

fi

exit 0
